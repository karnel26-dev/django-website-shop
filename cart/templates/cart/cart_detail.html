{% extends 'base.html' %}
{% load static %}

{% block content %}
<table class="cart-table" style="width:80%; text-align:justify; margin:0 auto;">
    <thead>
    <tr>
        <th>№</th>
        <th>Изображение</th>
        <th>Наименование</th>
        <th>Цена</th>
        <th>Количество</th>
        <th>Стоимость</th>
    </tr>
    </thead>
    {% for item in cart %}
            {% with product=item.product %}
            <tr>
                <input type="hidden" value="{{product.id}}" id="productId">
                <td>
                    {{ forloop.counter }}
                </td>
                <td>
                    {% if product.image %}
                    <img src="{{ product.image.url }}" style="width:30px; height:30px">
                    {% endif %}
                </td>
                <td>
                    {{ product.name }}
                </td>
                <td>
                    <span id="productPrice">{{ product.price|floatformat:0 }}</span> руб.
                </td>
                <td>
                    <input id="prod_quantity" name="prod_quantity" type="number" min="1" max="100000" value="{{ item.quantity }}">
                </td>
                <td>
                    <span id="itemPrice">{{ item.total_price|floatformat:0 }}</span>  руб.
                </td>
            </tr>
    {% endwith %}
    {% endfor %}
</table>

<div style="width:80%; text-align:justify; margin:0 auto;">
    <div>Товаров в корзине: <span id="cartLength">{{ cart|length }}</span></div>
    <div>Cумма товаров в корзине: <span id="totalPriceCart">{{ cart.get_total_price|floatformat:0 }}</span>  руб.</div>
</div>

<script>
    function getTotalPriceCart(){
    let itemPriceInputs = document.querySelectorAll("#itemPrice");
    let totalPrice = 0;
    itemPriceInputs.forEach((item, index)=>{
        totalPrice += +item.textContent;
        });
    let totalPriceCart = document.querySelector("#totalPriceCart");
    totalPriceCart.textContent = totalPrice;
    return totalPrice;
    }

    function getQuantityInCart(){
        let quantityInputs = document.querySelectorAll("#prod_quantity");
        let allQuantity = 0;
        quantityInputs.forEach((item,index)=>{
            allQuantity += +item.value;
        });
        let cartLength = document.querySelector("#cartLength");
        cartLength.textContent = allQuantity;
        return allQuantity;
    }

    function updatePrice(event){
        let quantity = event.target.value;
        let itemPrice = event.target.parentElement.parentElement.querySelector("#itemPrice")
        let productPrice = event.target.parentElement.parentElement.querySelector("#productPrice").textContent
        productPrice = Number(productPrice.replace(",","."))

        let newItemPrice = productPrice * quantity;
        itemPrice.textContent = newItemPrice;
        getQuantityInCart();
        getTotalPriceCart();
    };

    async function saveCartInSession(){
        let cartInfo = {
            totalQuantity: getQuantityInCart(),
            totalPrice: getTotalPriceCart(),
        };

        let response = await fetch('/cart/update_cart_session/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json;charset=utf-8',
          },
          body: JSON.stringify(cartInfo),
        });

    let result = await response.json();
    };

    const quantityInput = document.querySelectorAll("#prod_quantity")
    quantityInput.forEach((item)=>{item.addEventListener('change', updatePrice)})
    quantityInput.forEach((item)=>{item.addEventListener('change', saveCartInSession)})

</script>

{% endblock content %}


